<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - zStudio</title>
    <link rel="stylesheet" href="style.css?v=1.5" />
</head>

<body>
    <!-- Navbar -->
    <div id="navbar-placeholder"></div>
    <script>
        fetch("navbar.html?v=1.5")
            .then(r => r.text())
            .then(h => {
                const navbarPlaceholder = document.getElementById("navbar-placeholder");
                navbarPlaceholder.innerHTML = h;
                // Evaluate any inline scripts in the loaded navbar
                navbarPlaceholder.querySelectorAll("script").forEach(script => {
                    const newScript = document.createElement("script");
                    newScript.textContent = script.textContent;
                    document.body.appendChild(newScript).parentNode.removeChild(newScript);
                });
            })
            .catch(() => console.error("Failed to load navbar"));
    </script>

    <main class="container">
        <h1>Dashboard</h1>
        <p>Welcome, <span id="user-email"></span>!</p>

        <!-- Licenses Block -->
        <div class="dashboard-block">
            <h2>Your Licenses</h2>
            <table id="licenses-table">
                <thead>
                    <tr>
                        <th>License Name</th>
                        <th>Status</th>
                        <th>Seats</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Licenses will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Buy License Button -->
        <div class="dashboard-block">
            <a href="buyLicense.html" class="button">Buy a License</a>
        </div>

        <!-- Logout Button -->
        <div class="dashboard-block">
            <button id="logout-btn" class="button">Logout</button>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer-placeholder"></div>
    <script>
        fetch("footer.html?v=" + Date.now())
            .then(r => r.text())
            .then(h => {
                const footerPlaceholder = document.getElementById("footer-placeholder");
                footerPlaceholder.innerHTML = h;
                footerPlaceholder.querySelectorAll("script").forEach(script => {
                    const newScript = document.createElement("script");
                    newScript.textContent = script.textContent;
                    document.body.appendChild(newScript).parentNode.removeChild(newScript);
                });
            })
            .catch(() => console.error("Failed to load footer"));
    </script>

    <script>
        // Inline auth functions for reliability
        if (!window.isLoggedIn) {
            window.isLoggedIn = () => {
                return localStorage.getItem('loggedIn') === 'true';
            };
            window.getUserEmail = () => {
                return localStorage.getItem('userEmail') || '';
            };
            window.apiGetLicenses = async () => {
                console.log('Fetching licenses');
                let licenses = JSON.parse(localStorage.getItem('licenses') || 'null');
                if (!licenses) {
                    licenses = [
                        { id: 1, name: 'License 1', status: 'Active', seatsTotal: 5 },
                        { id: 2, name: 'License 2', status: 'Expired', seatsTotal: 3 }
                    ];
                    localStorage.setItem('licenses', JSON.stringify(licenses));
                }
                // Calculate occupied seats from stored users
                licenses.forEach(license => {
                    const users = JSON.parse(localStorage.getItem('license_users_' + license.id) || '[]');
                    license.seatsOccupied = users.length;
                });
                return licenses;
            };
            window.apiLogout = async () => {
                console.log('Logging out');
                return { success: true };
            };

            async function renewLicense(id) {
                const licenses = JSON.parse(localStorage.getItem('licenses') || '[]');
                const license = licenses.find(l => l.id == id);
                if (license) {
                    license.status = 'Active';
                    localStorage.setItem('licenses', JSON.stringify(licenses));
                    // Reload the table
                    const licensesData = await window.apiGetLicenses();
                    loadLicensesTable(licensesData);
                }
            }

            async function cancelLicense(id) {
                const licenses = JSON.parse(localStorage.getItem('licenses') || '[]');
                const license = licenses.find(l => l.id == id);
                if (license) {
                    license.status = 'Expired';
                    localStorage.setItem('licenses', JSON.stringify(licenses));
                    // Reload the table
                    const licensesData = await window.apiGetLicenses();
                    loadLicensesTable(licensesData);
                }
            }

            function loadLicensesTable(licenses) {
                const tbody = document.querySelector('#licenses-table tbody');
                tbody.innerHTML = '';
                licenses.forEach(license => {
                    const actionButton = license.status === 'Expired'
                        ? `<button class="action-btn renew-btn" data-id="${license.id}">Renew</button>`
                        : `<button class="action-btn cancel-btn" data-id="${license.id}">Cancel</button>`;
                    const row = document.createElement('tr');
                    row.innerHTML = `
            <td><a href="editSeats.html?id=${license.id}">${license.name}</a></td>
            <td>${license.status}</td>
            <td>${license.seatsOccupied}/${license.seatsTotal}</td>
            <td>${actionButton}</td>
          `;
                    tbody.appendChild(row);
                });

                // Add event listeners for action buttons
                document.querySelectorAll('.renew-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        renewLicense(id);
                    });
                });
                document.querySelectorAll('.cancel-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        cancelLicense(id);
                    });
                });
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Check if logged in
            if (!window.isLoggedIn()) {
                window.location.href = 'login.html';
                return;
            }

            // Display user email
            document.getElementById('user-email').textContent = window.getUserEmail();

            // Load licenses
            try {
                const licenses = await window.apiGetLicenses();
                loadLicensesTable(licenses);
            } catch (error) {
                console.error('Error loading licenses:', error);
                document.querySelector('#licenses-table tbody').innerHTML = '<tr><td colspan="4">Error loading licenses</td></tr>';
            }

            // Logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await window.apiLogout();
                        localStorage.setItem('loggedIn', 'false');
                        localStorage.setItem('userEmail', '');
                        localStorage.removeItem('storedEmail');
                        localStorage.removeItem('storedPassword');
                        window.location.href = 'index.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        // Still logout locally
                        localStorage.setItem('loggedIn', 'false');
                        localStorage.setItem('userEmail', '');
                        localStorage.removeItem('storedEmail');
                        localStorage.removeItem('storedPassword');
                        window.location.href = 'index.html';
                    }
                });
            }
        });
    </script>
</body>

</html>